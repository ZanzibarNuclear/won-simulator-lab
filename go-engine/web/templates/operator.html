{{define "operator"}}
<div class="operator-container">
    <div class="sim-card">
        <h2><span id="active-sim-name"></span></h2>
        <div class="sim-details">
            <p><strong>ID:</strong> <span id="active-sim-id"></span></p>
            <p><strong>Motto:</strong> <span id="active-sim-motto"></span></p>
            <p><strong>Started Simulation At:</strong> <span id="active-sim-spawned-at"></span></p>
            <p><strong>Simulation Time:</strong> <span id="current-time"></span></p>
            <p><strong>Weather:</strong> <span id="current-weather"></span></p>
        </div>
    </div>

    <div class="sim-controls">
        <h3>Simulator Controls</h3>
        <div class="advance-control">
            <select id="advance-steps">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
            <select id="advance-unit">
                <option value="minutes" selected>Minutes</option>
                <option value="hours">Hours</option>
                <option value="days">Days</option>
            </select>
            <button id="advance-sim">Advance Simulation</button>
            <button id="pause-sim">Pause Simulation</button>
        </div>
    </div>

    <div class="sim-status">
        <h3>Operational Status</h3>
        <div class="sim-details">
            <p><strong>State:</strong> <span id="operational-state"></span></p>
        </div>
        <div class="component-status">
            <h3>Component Status</h3>
            <div id="component-cards" class="simulations-grid">
                <!-- Component cards will be dynamically inserted here -->
            </div>
        </div>
    </div>
</div>

<script>
    let activeSimId = null;

    function updateSimInfo(simInfo) {
        document.getElementById('active-sim-id').textContent = simInfo.id;
        document.getElementById('active-sim-name').textContent = simInfo.name;
        document.getElementById('active-sim-motto').textContent = simInfo.motto;
        document.getElementById('active-sim-spawned-at').textContent = formatDateTime(new Date(simInfo.spawned_at));
    }

    function updateStatus(status) {
        document.getElementById('current-time').textContent = formatDateTime(new Date(status.simTime));
        document.getElementById('current-weather').textContent = status.weather || 'N/A';
        document.getElementById('operational-state').textContent = status.running ? 'Running' : 'Stopped';
    }

    function updateComponentCards(components) {
        const componentCardsContainer = document.getElementById('component-cards');
        componentCardsContainer.innerHTML = ''; // Clear existing cards

        components.forEach(component => {
            console.log(component);
            const card = document.createElement('div');
            card.className = 'component-card';
            const componentProperties = Object.entries(component).filter(([key]) => key !== 'name' && key !== 'type');
            let propertiesHTML = '';
            componentProperties.forEach(([key, value]) => {
                if (key === 'lastUpdated') {
                    value = formatDateTime(new Date(value));
                }
                propertiesHTML += `<p>${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}</p>`;
            });
            card.innerHTML = `<h4>${component.name}</h4>${propertiesHTML}`;
            componentCardsContainer.appendChild(card);
        });
    }

    document.getElementById('advance-sim').addEventListener('click', () => {
        if (!activeSimId) return;
        const steps = document.getElementById('advance-steps').value;
        const unit = document.getElementById('advance-unit').value;
        let totalSteps = parseInt(steps);

        if (unit === 'hours') {
            totalSteps *= 60;
        } else if (unit === 'days') {
            totalSteps *= 1440; // 24 hours * 60 minutes
        }

        fetch(`/api/sims/${activeSimId}/advance`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ steps: totalSteps })
        })
            .then(response => response.json())
            .then(status => updateStatus(status))
            .catch(error => console.error('Error:', error));
    });

    document.getElementById('pause-sim').addEventListener('click', () => {
        if (!activeSimId) return;
        fetch(`/api/sims/${activeSimId}/interrupt`, { method: 'PUT' })
            .then(response => response.json())
            .then(status => updateStatus(status))
            .catch(error => console.error('Error:', error));
    });

    // Fetch initial simulation info and status
    const urlParams = new URLSearchParams(window.location.search);
    const simId = urlParams.get('id');
    if (simId) {
        fetch(`/api/sims/${simId}`)
            .then(response => response.json())
            .then(simInfo => {
                activeSimId = simInfo.id;
                updateSimInfo(simInfo);
                return fetch(`/api/sims/${simId}/status`);
            })
            .then(response => response.json())
            .then(status => {
                updateStatus(status);
                updateComponentCards(status.components);
            })
            .catch(error => console.error('Error:', error));
    } else {
        console.error('No simulation ID provided in URL');
    }
</script>
{{end}}